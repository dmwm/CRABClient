#!/bin/bash
set -x

script_dir=`dirname $0`
python_cmd="python"
[ -z "$CMSSW_VERSION" ] && echo "CMSSW is missing. You must do cmsenv first" && exit
CMSSW_Major=$(echo $CMSSW_VERSION | cut -d_ -f2)  # e.g. from CMSSW_13_1_x this is "13"
CMSSW_Serie=$(echo $CMSSW_VERSION | cut -d_ -f3)  # e.g. from CMSSW_10_6_x this is "6"

# CRAB can use python3 starting from CMSSW_11
# would be good to do also for CMSSW_10_6 + (for UL) but there are problems with pycurl
# OTOH CRABClient should ony be using CLI curl now. This needs revisiting
[ $CMSSW_Major -ge 11 ] && python_cmd="python3"

# [ $CMSSW_Major -eq 10 ] && [ $CMSSW_Serie -ge 6 ] && python_cmd="python3"

if [ $python_cmd = "python3" ] ; then
  # can also include Rucio client (we do not want to deal with old python2 client)
  export RUCIO_HOME=`${script_dir}/rucio_home.sh`
  RUCIO_PYTHONPATH=`${script_dir}/rucio_pythonpath.sh`
  # alter PYTHONPATH here to keep flexibility to add or append as we find better
  export PYTHONPATH=$RUCIO_PYTHONPATH:$PYTHONPATH
fi

echo $RUCIO_HOME
cat $RUCIO_HOME/etc/rucio.cfg
echo "now launching crab.py"
exec ${python_cmd} ${script_dir}/crab.py ${1+"$@"}
